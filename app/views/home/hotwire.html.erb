<%# app/views/flights/map.html.erb %>

<%# Leaflet CSS/JS via CDN %>
<% content_for :head do %>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>
<% end %>

<div class="mx-1 flex flex-1 flex-col px-4 py-8 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight text-slate-900">
        Flight Map
      </h1>
      <p class="mt-1 max-w-2xl text-sm text-slate-600">
        A visual log of your travel history. Each route represents a flight you’ve logged.
      </p>
    </div>

    <%= link_to "Log a flight",
          new_flight_path,
          class: "
            inline-flex items-center rounded-full
            bg-slate-900 px-4 py-2
            text-sm font-semibold text-white
            shadow-sm
            hover:bg-slate-800
            focus-visible:outline focus-visible:outline-2
            focus-visible:outline-offset-2
            focus-visible:outline-slate-900
          " %>
  </div>

  <!-- Map -->
  <div class="relative flex flex-1">
    <div class="relative flex-1">
      <div
        id="flight-map"
        class="h-[70vh] w-full rounded-xl bg-slate-50 ring-1 ring-slate-200"
      ></div>

      <% if @map_flights.blank? %>
        <!-- Empty state overlay -->
        <div class="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div class="rounded-xl bg-white/90 px-6 py-5 text-center shadow ring-1 ring-black/5">
            <div class="mx-auto mb-3 flex h-10 w-10 items-center justify-center rounded-full bg-slate-100">
              ✈️
            </div>
            <p class="text-sm font-semibold text-slate-900">
              No flights yet
            </p>
            <p class="mt-1 text-sm text-slate-600">
              Add a flight to start building your map.
            </p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Data for JS -->
  <script type="application/json" id="flights-data">
    <%= raw(@map_flights.to_json) %>
  </script>

  <!-- Map JS -->
  <script>
    document.addEventListener("turbo:load", () => {
      const mapEl = document.getElementById("flight-map");
      if (!mapEl) return;
      if (mapEl.dataset.initialized === "true") return;
      mapEl.dataset.initialized = "true";

      const flights = JSON.parse(
        document.getElementById("flights-data")?.textContent || "[]"
      );

      const map = L.map("flight-map", { scrollWheelZoom: true });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const bounds = L.latLngBounds([]);

      const palette = [
        "#2563eb", // blue
        "#16a34a", // green
        "#dc2626", // red
        "#7c3aed", // purple
        "#ea580c", // orange
        "#0d9488", // teal
        "#db2777", // pink
        "#4b5563"  // slate
      ];

      function colorForYear(year) {
        if (!year) return "#4b5563";
        return palette[Math.abs(Number(year)) % palette.length];
      }

      flights.forEach((f) => {
        if (!f.departure || !f.arrival) return;

        const dep = L.latLng(f.departure.lat, f.departure.lng);
        const arr = L.latLng(f.arrival.lat, f.arrival.lng);

        bounds.extend(dep);
        bounds.extend(arr);

        const color = colorForYear(f.year);

        L.circleMarker(dep, {
          radius: 5,
          color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(map)
          .bindPopup(`<strong>${f.departure.code}</strong> — ${f.departure.name}`);

        L.circleMarker(arr, {
          radius: 5,
          color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(map)
          .bindPopup(`<strong>${f.arrival.code}</strong> — ${f.arrival.name}`);

        L.polyline([dep, arr], {
          weight: 3,
          opacity: 0.85,
          color
        }).addTo(map)
          .bindPopup(`
            <div class="space-y-1">
              <div class="text-sm font-semibold">
                ${f.departure.code} → ${f.arrival.code}
                ${f.departure_date ? `(${f.departure_date})` : ""}
              </div>
              <div class="text-xs text-slate-600">
                ${f.departure.name} → ${f.arrival.name}
              </div>
            </div>
          `);
      });

      if (flights.length > 0 && bounds.isValid()) {
        map.fitBounds(bounds.pad(0.2));
      } else {
        map.setView([39.5, -98.35], 4);
      }
    });
  </script>
</div>